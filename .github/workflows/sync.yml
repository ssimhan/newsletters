name: Auto Ingest (Substack + Podcast)

on:
  workflow_dispatch:
    inputs:
      run_substack:
        description: "Run Substack ingest"
        required: false
        default: "true"
      run_podcast:
        description: "Run Podcast ingest"
        required: false
        default: "true"
  schedule:
    - cron: "17 9 * * *" # daily 09:17 UTC

permissions:
  contents: write

concurrency:
  group: auto-ingest
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      REPO_OWNER: "ssimhan"
      REPO_NAME: "newsletters"
      DEFAULT_BRANCH: "main"
      SUBSTACK_FEED: "https://substack.gauravvohra.com/feed"
      PODCAST_FEED: "https://feeds.simplecast.com/Hb_IuXOo"
      GITHUB_TOKEN: ${{ secrets.PAT_REPO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (robust)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Show config (no secrets)
        run: |
          node -e "import('./src/config.js').then(m=>{const {token,...rest}=m.cfg; console.log('CFG:', rest)})"
          echo "HAS_SUBSTACK_FEED=${{ env.SUBSTACK_FEED != '' }}"
          echo "HAS_PODCAST_FEED=${{ env.PODCAST_FEED != '' }}"
          node -v
          npm -v
          echo "Repo files:"
          ls -la

      - name: Substack ingest
        if: ${{ github.event_name == 'schedule' || inputs.run_substack == 'true' }}
        env:
          NODE_OPTIONS: "--trace-warnings"
        run: npm run ingest:substack

            - name: Normalize Substack filenames
        run: bash scripts/normalize-substack-filenames.sh

      - name: Commit & push normalized filenames (safe rebase)
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet; then
            git add -A
            git commit -m "ci: strip hash suffixes from Substack filenames"
            git fetch origin "${{ env.DEFAULT_BRANCH }}"
            git rebase "origin/${{ env.DEFAULT_BRANCH }}" || git pull --rebase --no-edit
            git push origin HEAD:"${{ env.DEFAULT_BRANCH }}"
          else
            echo "No Substack hash suffixes to strip"
          fi

      - name: Validate + fix (do not fail job)
        run: npm run validate:fix || true

      - name: Commit validator fixes (if any)
        run: |
          # allow commits from Actions
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "ci: normalize frontmatter & filenames"
            git push origin ${{ env.DEFAULT_BRANCH }}
          else
            echo "No changes to commit"
          fi

      - name: Validate (post-fix must be clean)
        run: npm run validate
