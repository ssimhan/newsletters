name: Auto Ingest (Substack + Podcast)

on:
  workflow_dispatch:
    inputs:
      run_substack:
        description: "Run Substack ingest"
        required: false
        default: "true"
      run_podcast:
        description: "Run Podcast ingest"
        required: false
        default: "true"
  schedule:
    - cron: "17 9 * * *" # daily 09:17 UTC

permissions:
  contents: write

concurrency:
  group: auto-ingest
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      REPO_OWNER: "ssimhan"
      REPO_NAME: "newsletters"
      DEFAULT_BRANCH: "main"
      SUBSTACK_FEED: "https://substack.gauravvohra.com/feed"
      PODCAST_FEED: "https://feeds.simplecast.com/Hb_IuXOo"
      GITHUB_TOKEN: ${{ secrets.PAT_REPO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (robust)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Show config (no secrets)
        run: |
          node -e "import('./src/config.js').then(m=>{const {token,...rest}=m.cfg; console.log('CFG:', rest)})"
          echo "HAS_SUBSTACK_FEED=${{ env.SUBSTACK_FEED != '' }}"
          echo "HAS_PODCAST_FEED=${{ env.PODCAST_FEED != '' }}"
          node -v
          npm -v
          echo "Repo files:"
          ls -la

      - name: Substack ingest
        if: ${{ github.event_name == 'schedule' || inputs.run_substack == 'true' }}
        env:
          NODE_OPTIONS: "--trace-warnings"
        run: npm run ingest:substack

      - name: Normalize Substack filenames (strip hash suffix)
        run: |
          set -e
          shopt -s nullglob
          changed=0
          for f in substack/*.md; do
            base="$(basename "$f")"
            # pattern: YYYY-MM-DD-title-aaaaaaaa.md  OR  YYYY-MM-DD-title--aaaaaaaa.md
            if [[ "$base" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2}-.+?)--?[0-9a-f]{8}\.md$ ]]; then
              new="${BASH_REMATCH[1]}.md"
              echo "Renaming $base -> $new"
              git mv -f "substack/$base" "substack/$new" || mv -f "substack/$base" "substack/$new"
              changed=1
            fi
          done

          if [ "$changed" -eq 1 ]; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "ci: strip hash suffixes from Substack filenames"
            git push origin ${{ env.DEFAULT_BRANCH }}
          else
            echo "No Substack hash suffixes to strip"
          fi

      - name: Validate + fix (do not fail job)
        run: npm run validate:fix || true

      - name: Commit validator fixes (if any)
        run: |
          # allow commits from Actions
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "ci: normalize frontmatter & filenames"
            git push origin ${{ env.DEFAULT_BRANCH }}
          else
            echo "No changes to commit"
          fi

      - name: Validate (post-fix must be clean)
        run: npm run validate